# ğŸ® Treasure Hunt Game (å¯»å®æ¸¸æˆ)

## æ¦‚è¿° (Overview)

è¿™æ˜¯ä¸€ä¸ªä¸ºbavabotå¼€å‘çš„å¯»å®æ¸¸æˆåŠŸèƒ½ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡`/hunt`å‘½ä»¤å¼€å§‹å¯»å®æ¸¸æˆï¼Œæ”¶é›†ç¢ç‰‡å¹¶åˆæˆå®ç‰©ã€‚

This is a treasure hunt game feature developed for bavabot. Users can start treasure hunt games with the `/hunt` command, collect fragments, and synthesize treasures.

## åŠŸèƒ½ç‰¹ç‚¹ (Features)

### ğŸ¯ æ¸¸æˆæœºåˆ¶ (Game Mechanics)
- **å¼€å§‹æ¸¸æˆ**: ä½¿ç”¨ `/hunt` å‘½ä»¤å…è´¹å¼€å§‹æ¸¸æˆ
- **æ¸¸æˆæ—¶é•¿**: æ¯åœºæ¸¸æˆæŒç»­30åˆ†é’Ÿ
- **å¯»å®åŠ¨ä½œ**: æ¯æ¬¡å¯»å®æ¶ˆè€—1ä¸ªé‡‘å¸ï¼Œ1ç§’å†·å´æ—¶é—´
- **æ¯æ—¥é™åˆ¶**: æ¯ç”¨æˆ·æ¯å¤©æœ€å¤š5åœºæ¸¸æˆ

### ğŸ§© ç¢ç‰‡ç³»ç»Ÿ (Fragment System)
- **ç¢ç‰‡ç±»å‹**: 6ç§ç¢ç‰‡ (1-6)
- **éšæœºè·å¾—**: æ¯æ¬¡å¯»å®éšæœºè·å¾—ä¸€ä¸ªç¢ç‰‡
- **æœ‰æ•ˆæœŸ**: ç¢ç‰‡ä»…åœ¨è·å¾—å½“å¤©æœ‰æ•ˆï¼Œåˆå¤œæ¸…é™¤

### ğŸ† å®ç‰©ç³»ç»Ÿ (Treasure System)
- **å®ç‰©ç±»å‹**: 
  - å®ç‰© "m": éœ€è¦ç¢ç‰‡ 1, 2, 3
  - å®ç‰© "l": éœ€è¦ç¢ç‰‡ 4, 5, 6
- **æ¯æ—¥å®ç‰©**: æ¯å¤©éšæœºé€‰æ‹©ä¸€ä¸ªç›®æ ‡å®ç‰©
- **åˆæˆ**: æ”¶é›†é½æ‰€éœ€ç¢ç‰‡å³å¯åˆæˆå®ç‰©

### ğŸ® ç•Œé¢åŠŸèƒ½ (Interface Features)
- **å¯»å®æŒ‰é’®**: è¿›è¡Œå¯»å®åŠ¨ä½œ
- **èƒŒåŒ…æŸ¥çœ‹**: æŸ¥çœ‹å½“å‰æ‹¥æœ‰çš„ç¢ç‰‡
- **åˆæˆç•Œé¢**: æ£€æŸ¥åˆæˆæ¡ä»¶å¹¶æ‰§è¡Œåˆæˆ
- **æ¸¸æˆç»“æŸ**: æ‰‹åŠ¨ç»“æŸæ¸¸æˆæˆ–30åˆ†é’Ÿè‡ªåŠ¨ç»“æŸ

## æ•°æ®åº“ç»“æ„ (Database Schema)

### Hunt Table (å¯»å®ä¼šè¯è¡¨)
```sql
- id: ä¼šè¯ID (Primary Key)
- tg: ç”¨æˆ·Telegram ID
- start_time: æ¸¸æˆå¼€å§‹æ—¶é—´
- end_time: æ¸¸æˆç»“æŸæ—¶é—´
- game_date: æ¸¸æˆæ—¥æœŸ
- is_active: æ¸¸æˆæ˜¯å¦è¿›è¡Œä¸­
- fragments_found: æ‰¾åˆ°çš„ç¢ç‰‡æ•°é‡
- coins_spent: æ¶ˆè€—çš„é‡‘å¸æ•°é‡
- last_hunt_time: ä¸Šæ¬¡å¯»å®æ—¶é—´
```

### Fragment Table (ç¢ç‰‡è¡¨)
```sql
- id: ç¢ç‰‡ID (Primary Key)
- tg: ç”¨æˆ·Telegram ID
- fragment_id: ç¢ç‰‡ç±»å‹ (1-6)
- obtained_date: è·å¾—æ—¥æœŸ
- obtained_time: è·å¾—æ—¶é—´
- hunt_session_id: å¯¹åº”çš„å¯»å®ä¼šè¯ID
```

### Treasure Table (å®ç‰©é…ç½®è¡¨)
```sql
- id: å®ç‰©ID (Primary Key)
- treasure_name: å®ç‰©åç§°
- fragment_ids: éœ€è¦çš„ç¢ç‰‡ID (é€—å·åˆ†éš”)
- description: å®ç‰©æè¿°
```

### DailyTreasure Table (æ¯æ—¥å®ç‰©è¡¨)
```sql
- date: æ—¥æœŸ (Primary Key)
- treasure_id: å½“æ—¥å®ç‰©ID
```

## æ–‡ä»¶ç»“æ„ (File Structure)

```
bot/
â”œâ”€â”€ sql_helper/
â”‚   â””â”€â”€ sql_hunt.py              # å¯»å®æ¸¸æˆæ•°æ®åº“æ“ä½œ
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ commands/
â”‚       â”œâ”€â”€ hunt.py              # å¯»å®æ¸¸æˆå‘½ä»¤å’Œå›è°ƒå¤„ç†
â”‚       â””â”€â”€ __init__.py          # å¯¼å…¥å¯»å®å‘½ä»¤
â””â”€â”€ scheduler/
    â”œâ”€â”€ hunt_scheduler.py        # å¯»å®æ¸¸æˆå®šæ—¶ä»»åŠ¡
    â””â”€â”€ __init__.py             # å¯¼å…¥å®šæ—¶ä»»åŠ¡
```

## API å‡½æ•° (API Functions)

### SQL Helper Functions
- `sql_start_hunt(tg)`: å¼€å§‹æ–°çš„å¯»å®æ¸¸æˆ
- `sql_end_hunt(hunt_id)`: ç»“æŸå¯»å®æ¸¸æˆ
- `sql_get_active_hunt(tg)`: è·å–ç”¨æˆ·æ´»è·ƒçš„æ¸¸æˆä¼šè¯
- `sql_add_fragment(tg, hunt_id, fragment_id)`: æ·»åŠ ç¢ç‰‡
- `sql_get_user_fragments(tg, today_only)`: è·å–ç”¨æˆ·ç¢ç‰‡
- `sql_get_today_hunt_count(tg)`: è·å–ä»Šæ—¥æ¸¸æˆæ¬¡æ•°
- `sql_get_daily_treasure(date)`: è·å–æ¯æ—¥å®ç‰©
- `sql_check_treasure_synthesis(tg, treasure_id)`: æ£€æŸ¥åˆæˆæ¡ä»¶
- `sql_synthesize_treasure(tg, treasure_id)`: æ‰§è¡Œå®ç‰©åˆæˆ
- `sql_cleanup_expired_fragments()`: æ¸…ç†è¿‡æœŸç¢ç‰‡

### Command Handlers
- `start_hunt()`: `/hunt` å‘½ä»¤å¤„ç†
- `hunt_action()`: å¯»å®åŠ¨ä½œå›è°ƒ
- `hunt_inventory()`: èƒŒåŒ…æŸ¥çœ‹å›è°ƒ
- `hunt_synthesis()`: åˆæˆç•Œé¢å›è°ƒ
- `hunt_do_synthesis()`: æ‰§è¡Œåˆæˆå›è°ƒ
- `hunt_end()`: ç»“æŸæ¸¸æˆå›è°ƒ
- `hunt_game_return()`: è¿”å›æ¸¸æˆå›è°ƒ

## å®šæ—¶ä»»åŠ¡ (Scheduled Tasks)

### è‡ªåŠ¨æ¸…ç†ä»»åŠ¡
- **è¿‡æœŸç¢ç‰‡æ¸…ç†**: æ¯å¤©å‡Œæ™¨1ç‚¹æ¸…ç†å‰ä¸€å¤©çš„ç¢ç‰‡
- **è¶…æ—¶æ¸¸æˆæ¸…ç†**: æ¯10åˆ†é’Ÿæ¸…ç†è¶…è¿‡30åˆ†é’Ÿçš„æ´»è·ƒæ¸¸æˆ

## ä½¿ç”¨æ–¹æ³• (Usage)

### ç”¨æˆ·æ“ä½œæµç¨‹
1. å‘é€ `/hunt` å‘½ä»¤å¼€å§‹æ¸¸æˆ
2. ç‚¹å‡» "ğŸ¯ å¯»å®" æŒ‰é’®è¿›è¡Œå¯»å®ï¼ˆæ¶ˆè€—1é‡‘å¸ï¼‰
3. ç‚¹å‡» "ğŸ“¦ èƒŒåŒ…" æŸ¥çœ‹æ”¶é›†çš„ç¢ç‰‡
4. ç‚¹å‡» "ğŸ”§ åˆæˆ" æŸ¥çœ‹åˆæˆæ¡ä»¶
5. æ”¶é›†é½æ‰€éœ€ç¢ç‰‡åç‚¹å‡» "âœ¨ åˆæˆ" è·å¾—å®ç‰©
6. ç‚¹å‡» "âŒ ç»“æŸæ¸¸æˆ" æˆ–ç­‰å¾…30åˆ†é’Ÿè‡ªåŠ¨ç»“æŸ

### æ¸¸æˆè§„åˆ™
- æ¯ç”¨æˆ·æ¯å¤©æœ€å¤š5åœºæ¸¸æˆ
- æ¯æ¬¡å¯»å®æ¶ˆè€—1ä¸ªé‡‘å¸
- å¯»å®æœ‰1ç§’å†·å´æ—¶é—´
- ç¢ç‰‡ä»…å½“å¤©æœ‰æ•ˆ
- æ¯æ—¥éšæœºé€‰æ‹©ç›®æ ‡å®ç‰©

## é…ç½®æ‰©å±• (Configuration & Extension)

### æ·»åŠ æ–°å®ç‰©
åœ¨ `sql_hunt.py` çš„ `init_treasures()` å‡½æ•°ä¸­æ·»åŠ æ–°çš„å®ç‰©é…ç½®ï¼š

```python
treasures = [
    Treasure(treasure_name="æ–°å®ç‰©å", fragment_ids="7,8,9", description="æ–°å®ç‰©æè¿°"),
    # ... å…¶ä»–å®ç‰©
]
```

### è°ƒæ•´æ¸¸æˆå‚æ•°
- æ¸¸æˆæ—¶é•¿: ä¿®æ”¹ `1800` ç§’ (30åˆ†é’Ÿ)
- æ¯æ—¥é™åˆ¶: ä¿®æ”¹ `5` æ¬¡
- å†·å´æ—¶é—´: ä¿®æ”¹ `1` ç§’
- å¯»å®æˆæœ¬: ä¿®æ”¹ `1` é‡‘å¸

## æµ‹è¯• (Testing)

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š
```bash
python /tmp/test_hunt.py     # åŸºç¡€åŠŸèƒ½æµ‹è¯•
python /tmp/demo_hunt.py     # æ¸¸æˆæ¼”ç¤º
```

## å®‰å…¨è€ƒè™‘ (Security Considerations)

- âœ… é˜²æ­¢é‡å¤å¼€å§‹æ¸¸æˆ
- âœ… éªŒè¯æ¸¸æˆä¼šè¯æœ‰æ•ˆæ€§  
- âœ… é‡‘å¸æ‰£é™¤å¤±è´¥æ—¶å›æ»š
- âœ… å†·å´æ—¶é—´é˜²æ­¢å¿«é€Ÿç‚¹å‡»
- âœ… æ¸¸æˆè¶…æ—¶è‡ªåŠ¨ç»“æŸ
- âœ… è¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†

## æ€§èƒ½ä¼˜åŒ– (Performance Optimizations)

- âœ… æ•°æ®åº“è¿æ¥æ± 
- âœ… äº‹åŠ¡å›æ»šæœºåˆ¶
- âœ… å®šæ—¶æ¸…ç†è¿‡æœŸæ•°æ®
- âœ… ç´¢å¼•ä¼˜åŒ– (é€šè¿‡Telegram ID)
- âœ… ç¼“å­˜æ¯æ—¥å®ç‰©é…ç½®

## æ—¥å¿—è®°å½• (Logging)

ç³»ç»Ÿè®°å½•ä»¥ä¸‹äº‹ä»¶ï¼š
- æ¸¸æˆå¼€å§‹/ç»“æŸ
- ç¢ç‰‡è·å¾—
- å®ç‰©åˆæˆ
- é”™è¯¯å’Œå¼‚å¸¸
- å®šæ—¶æ¸…ç†ä»»åŠ¡

## æ•…éšœæ’é™¤ (Troubleshooting)

### å¸¸è§é—®é¢˜
1. **æ•°æ®åº“è¿æ¥å¤±è´¥**: æ£€æŸ¥æ•°æ®åº“é…ç½®
2. **è¡¨ä¸å­˜åœ¨**: ç¡®ä¿è¿è¡Œäº†è¡¨åˆ›å»ºä»£ç 
3. **å†·å´æ—¶é—´ä¸ç”Ÿæ•ˆ**: æ£€æŸ¥æ—¶é—´åŒæ­¥
4. **ç¢ç‰‡ä¸æ˜¾ç¤º**: æ£€æŸ¥æ—¥æœŸæ ¼å¼

### è°ƒè¯•æ–¹æ³•
- æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
- éªŒè¯æ•°æ®åº“è¡¨ç»“æ„
- æµ‹è¯•å„ä¸ªSQLå‡½æ•°
- ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬

---

ğŸ® **å¯»å®æ¸¸æˆå·²å‡†å¤‡å°±ç»ªï¼ç¥æ‚¨æ¸¸æˆæ„‰å¿«ï¼**